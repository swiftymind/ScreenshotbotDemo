name: Screenshotbot CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: List available schemes
      run: |
        xcodebuild -workspace ScreenshotbotDemo.xcworkspace -list

    - name: Build and Test
      run: |
        xcodebuild test \
          -workspace ScreenshotbotDemo.xcworkspace \
          -scheme ScreenshotbotDemo \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData

    - name: Find screenshots
      run: |
        find DerivedData -name "*.png" -type f
        find DerivedData -name "*.jpg" -type f

    - name: Run Screenshotbot
      run: |
        curl -L -o screenshotbot "https://github.com/screenshotbot/screenshotbot-cli/releases/latest/download/screenshotbot-macos"
        chmod +x screenshotbot
        ./screenshotbot \
          --api-key=${{ secrets.SCREENSHOTBOT_API_KEY }} \
          --channel=ci \
          --directory=DerivedData/Logs/Test \
          --fail-on-regression=true

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4  # Updated to v4
      with:
        name: test-results
        path: |
          DerivedData/Logs/Test/
          DerivedData/Logs/Test/*.png
          DerivedData/Logs/Test/*.jpg
        if-no-files-found: warn  # Added to handle cases with no files
        retention-days: 30  # Added to set retention period
